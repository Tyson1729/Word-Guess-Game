CREATE OR REPLACE FUNCTION attach_audit_trigger(table_identity TEXT)
RETURNS TEXT AS $$
DECLARE
    pk_columns_list TEXT;
    v_schema_name TEXT;
    v_table_name TEXT;
BEGIN
    -- Extract schema and table name from the input
    v_schema_name := split_part(table_identity, '.', 1);
    v_table_name  := split_part(table_identity, '.', 2);

    -- Find all PK columns for this table
    SELECT string_agg(quote_literal(kcu.column_name), ', ')
    INTO pk_columns_list
    FROM information_schema.table_constraints AS tc
    JOIN information_schema.key_column_usage AS kcu
      ON tc.constraint_name = kcu.constraint_name
      AND tc.table_schema = kcu.table_schema
    WHERE tc.constraint_type = 'PRIMARY KEY'
      AND tc.table_schema = v_schema_name
      AND tc.table_name = v_table_name;

    -- Dynamically create the trigger
    EXECUTE format(
        'CREATE TRIGGER trg_audit_changes_on_%s ' ||
        'AFTER INSERT OR UPDATE OR DELETE ON %I ' ||
        'FOR EACH ROW EXECUTE FUNCTION log_table_changes(%s);',
        v_table_name,        -- For a unique trigger name
        table_identity,      -- For the full table name
        COALESCE(pk_columns_list, '') -- Pass the list of PK columns
    );
    
    RETURN 'Audit trigger attached to ' || table_identity;
EXCEPTION
    WHEN OTHERS THEN
        RETURN 'Could not attach trigger. ERROR: ' || SQLERRM;
END;
$$ LANGUAGE plpgsql;




CREATE TABLE monthly_sales (
    Customer_Name TEXT,
    Month_Year TEXT, -- e.g., '2025-11'
    sales_amount NUMERIC(10, 2),
    PRIMARY KEY (Customer_Name, Month_Year)
);


CREATE TABLE monthly_sales (
    Customer_Name TEXT,
    Month_Year TEXT, -- e.g., '2025-11'
    sales_amount NUMERIC(10, 2),
    PRIMARY KEY (Customer_Name, Month_Year)
);


INSERT INTO monthly_sales (Customer_Name, Month_Year, sales_amount)
VALUES 
('Acme Corp', '2025-10', 1500.00),
('Beta Inc', '2025-10', 800.50);

UPDATE monthly_sales
SET sales_amount = 1650.00
WHERE Customer_Name = 'Acme Corp' AND Month_Year = '2025-10';

DELETE FROM monthly_sales
WHERE Customer_Name = 'Beta Inc';

DROP TABLE monthly_sales;

SELECT 
    audit_id, 
    table_name, 
    operation_type, 
    changed_at,
    primary_key_value,
    old_data,
    new_data
FROM audit_logs
ORDER BY audit_id;
